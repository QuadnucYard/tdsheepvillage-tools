# 游戏循环

游戏中 swf 涉及两个不同的 fps：24 和 25，但是 `TDSheepMain`  使用 25 Fps，这个类负责控制游戏的时间调度，对应一个 `REFRESH_RATE` 为 40，表示 1 秒处理 40 次。

迎战后，创建帧事件，按帧进行事件循环。战斗计时部分，有一个 `actionRate`，即倍率，开加速时其值为 2。有一个计数器 `count`，从 0 开始，每帧其值增加 `actionRate`，然后调度地图战斗事件。`MapTimer` 类调度。在 `action` 中，按以下顺序处理：生成狼，处理所有狼的运动（`stepMove`，如果 `count % 5 == 0` 则进行一次状态衰减（`statusDecay`），如果 `count % 5 == 3` 则进行一次技能施放检查），处理塔的攻击（`checkFire`，如果 `count % 5 == 0` 则状态衰减），然后依次处理陷阱、地图障碍（如火山）、弹簧、木箱、子弹，最后调度主事件（`mainEvent`，未了解）。

可见状态衰减是每秒进行 5 次，每次间隔 0.2s。

## 波 Wave

### `initWave`

1. 计算 `difficultyLevel` 和 `difficultyValue`。
2. 如果是驯化狼，用提供的 `MonsterData` 来生成 `Monster`，否则用类型、等级、难度系数来生成 `Monster`。
3. 对出怪列表中的所有狼进行初始化，如果有召唤、变身、转生技能，还要加载对应的资源。
4. 如果是防御地图，到此结束。
5. 获取 boss。如果存在，则让其他非 boss 的狼的最大血量乘 $0.8$（这个有点违背实际数据，待核查）。如果不存在，则获取随机 boss。设置显示的 boss 数据。
6. 设置当前波的奖励。

### `startWave`

初始化变量和寻路算法，调用一次 `addWolf()`。

### `addWolf`

如果不在出怪状态或当期地图不存在，退出。如果出完怪，调用 `stopWave()` 结束。

根据出怪规则 `unkennelRule` 讨论。这里有一个 `waveData.isSolo`，但其值恒为 `false`，没有影响（本来是 `unkennelSolo` 决定只有某个口出怪）。

- 如果是 `RANDOM(-1)`，随机选一个入口 `initWolf()`。目前只有沃夫沼泽用这个规则。
- 如果是 `SAME_TIME(0)`，对所有入口  `initWolf()`。目前只有拉帕斯村和防线用这个规则。
- 如果是 `FOLLOWED(>=1)`，计算 `index = int(unkennelCount / unkennelRule) % entranceCount`，在这个入口 `initWolf()`。其中 `unkennelCount ` 为已出怪数量。这个比较复杂，下面举几个例子。
  1. 卡西村，2 个出怪口，`unkennelRule=3`，一波 14 狼。产生的序列为 `0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4 `（取模前），这样就是每个口连续出 3 个后才让下一个出。呼噜噜村、凯奇镇、艾伊尔村 `unkennelRule` 也是 3，但是只有 1 个出怪口，从结果上来说没有影响。
  2. 麦恩矿山、银蛇之巅、菲洛克村、拉卡维村，2 个出怪口， `unkennelRule=2`，产生的序列为 `0, 0, 1, 1, 2, 2, ...`，每个口连续出 2 个。赤火地带、巴罗村、比丘村 `unkennelRule` 也是 2，但是只有 1 个出怪口，从结果上来说没有影响。
  3. 其他地图， `unkennelRule=1`，显然就是轮流出怪。

### `initWolf`

在当前波狼列表中找到目前的狼，初始化并加入到存活列表和地图。

## 塔 Tower

### `checkFire`

如果没准备好、不在战斗、等级≤0或没有子弹则退出。

首先处理事件 `castEvent`（待研究）。

然后计算冷却减少值：如果被地图上的道具加速或减速，则多乘一个倍率，让 `cooldownNum` 减去这个 `rate` 值。如果没冷却好，即 `cooldownNum > 0`，则退出。这个 `rate` 计算方法为，基础攻速乘上改变攻速的状态效果乘上墙给的加速效果，向上取整。让 `cooldownNum` 归零后，处理攻击。

定义 `reCheck` 值为 `true` 当且仅当当前瞄准目标不存在、死亡、脱离瞄准、不在范围内或打不到（在传送、被屋顶遮挡或隐身）。

执行下面判断：

1. 如果会多重攻击（散弹塔）：如果没有瞄准目标，且周围没别的目标，则退出，否则将目标设为最近的狼，对其和另外的狼进行攻击。没有最小范围限制。

2. 如果是光镶嵌塔（ `fieldAttack`），对范围内的所有狼攻击（`fire`）。

3. （不满足以上情况）如果满足 `reCheck`，则重新选择目标：如果范围为负（波动塔），找横纵最近的狼，否则找一般距离最近的狼作为目标（有最小范围，默认 350）。对目标进行攻击。如果能连击（黑哨塔），且满足概率判定，则把连击加入事件队列。如果能分散攻击（黑散弹），额外攻击该目标。

   TODO 目标的获取

   注：获取的目标按距离升序排列，意味着优先攻击近的。

   连击调用 `castComboAttack`，每次都会对目标 `fire` 一次。散弹一发子弹算攻击一次。

### `fire`

以上的攻击处理为 `fire`，参数有：`target, isFieldAttack, deflexion`。

攻击一次即让塔的份额（`offer`）加 1。

按下面条件进行判断：

1.  是光塔。抗光或弱光，则把这个伤害比例作为 `nextEffectRate` 进行直接 Aoe 攻击。
2.  是电塔（紫哨、散、镶）。如果发现目标是绝缘（没被筛掉），那么目标设空。立即让子弹（没错，闪电也算子弹）检查攻击。
3. 是波动塔。仅仅初始化了子弹。
4. 其他情况。初始化子弹，并计算子弹的运动学参数。

最后将 `cooldownNum` 设为 `2500`，并播放声音和动画。这里可以看到，攻速为 180 的哨塔，理论上是 0.556s 攻击一次（当然受帧率影响）。

注意一下，上面寻找目标要求距离大于 `rangeMin`，一般情况下这个值的 350，即塔宽度 700 的一半。

顺便找到了塔分经验的机制。

按份额分经验。攻击一次（有一发子弹就算一次，光塔打中几个就是几次）份额+1，打死狼份额+20，满级塔不参与分经验。

### 神奇的 `BurnColdSkill`

冰减速和火燃烧是统一的，这个能量值为正表示燃烧，为负表示减速。显示的是 `burn` 和 `cold` 值。

涉及到一个 `data.getLevelParam(level,0)`，经查，燃烧对应的值为 1，冰冻对应的值为 -1。

$\mathrm{burnColdValue}=\pm(\mathrm{tower.buffEffect}\times\mathrm{level})^2$，符号取决于是冰还是火。其中 `level` 是一个取决于宝石的参数，碎片为 20，强化为 100。如果来源不是塔， `buffEffect` 为 1。

$\mathrm{burn}=\sqrt{\mathrm{burnColdValue}}$

$\mathrm{cold}=\mathrm{burnColdValue}^{0.25}\times0.03$

对应的 `BurnColdStatus`，`burn` 和 `cold` 计算方法一样，在 `statusValue` 介于 $[-4, 4]$ 时状态无效。

冰火叠加的是 $\mathrm{burnColdValue}$ 而不是燃烧伤害。

解释一下满级碎片火加精华冰的组合。后者提供的 bcv 是 $-230400$，前者提供的是 $14400$，数值上只有后者的 $6\%$，显然很难抵消减速影响。

#### 灼冻值的来源

有个 `SkillsPackage`，里面存了多个 `Skill` 的引用。

考虑 `buffEffect`。在初始值上，除了波动塔和镶嵌塔为 0.1，其他塔都是 0。实际值计算如下：`towerData.buffEffect * level + 1`。这样解释了哨塔、散弹塔、炮塔的火伤害不随等级变化。红镶嵌塔的 BE 1 级为 1.1，50 为 6。实际数据，1 级红碎片镶燃烧伤害为 22，50 级的为120（对应 BCV 分别为是 440 和 14400）。宝石产生 1~5 的倍率。这样说明前面 `burnColdValue` 计算公式中的 `level` 就是宝石等级乘 20。但其他三塔的这个 `level` 还得看数据。

对于镶嵌塔，用 $L_t$ 表示塔等级，$L_g$ 表示宝石等级，则燃烧伤害 $B$ 和减速率 $C$ 可分别表示为：

$$B=20L_g(L_t/10+1)$$

$$C=\sqrt{20L_g(L_t/10+1)}\times 0.03$$

根据公式，50 级蓝强化镶嵌提供的减速率为 $73.5\%$。

## 陷阱 Trap

### `checkAttack`

1. 如果当前波不存在，或次数耗尽，退出。
2. 如果攻击延迟不是无限且不是窜天弹，计数减一，如果计数到 0 则调用 `attack()` 攻击。
3. 进行冷却，如果没到冷却完成，退出。
4. 如果有子弹。接下来攻击检查和塔的差不多，如果不能攻击当前目标，则换成最近的。如果是近身攻击，则调用 `attack`，否则调用 `fire(target)`。
5. 如果没有子弹。如果范围为负，则表明是范围的单位是格，找自身所在位置的狼作为目标，否则找范围内最近的狼作为目标。调用 `attack()` 攻击。

### `attack`

如果是 `COLD_BULLET`，朝 4 个垂直方向调用 `fire()`。

否则查找目标列表，调用 `expend` 消耗，生成子弹（如果有）和攻击特效。

### `fire`

对子弹类型分类讨论，生成子弹后设置其物理参数，最后调用 `expend` 消耗。

## 子弹 Bullet

### `stepMove`

如果落地了，调用 `checkAoe`（如果是范围攻击，则对所有范围内目标造成伤害，存在一个效果比例）。如果不是 AOE 或没有命中目标，则 miss。

如果会追踪，则获取一个加速度，并改变方向瞄准目标（有一个复杂的角位移计算）。

最后检查是否命中目标。（前面有很多物理运算和特效，略）

### `checkHit`

考虑 3 种情况：来自陷阱，是波动塔，其他。这个影响到碰撞范围和攻击类型的判定。找到**最近的能命中的**目标。

如果命中狼，则调用 `hitMonster` 并 `checkAoe`。如果是波动塔并攻击数量达到上限，退出。如果是弹射攻击且没达上限，找下一个目标（有电和非电的区别）并瞄准。

补充一下碰撞判定。如果子弹有高度，则要求合适高度范围内，然后检查水平距离是否在一定范围内。由此可见，狼的碰撞箱是圆柱形，子弹可看作圆面。圆和圆柱有公共部分才判定碰撞。

炮塔的 AOE 伤害用的是同样的判定，也是水平面圆形……所以如果打到比较高的狼，只有它能受到伤害。

形象地说，子弹是圆盘，去切割狼这个圆柱体，能切到则算命中。

狼有 `width`，`height` 两参数，在图形上描述矩形大小，其中 `height` 还和特效显示位置相关。在碰撞判定上，在计算水平距离时，结果为两点间距减去 `width/3 `。`height` 用于高度判定。矩形大小 `width*height` 是体型判别标准，面积大于等于 $487500$ 表示其为沉重的，否则受弹簧影响，且落地会晕眩 1s。

### `hitMonster`

如果目标存在且不在攻击列表中，则攻击敌人，并产生特效。并把它加入攻击列表中。

## 狼 Monster

### 血量计算

计算狼的血量（以赤火老二为例）

难度系数：`hard_ness=4.3(hardB), yield_val=100(hardA)`

老二等级属性：`a=440, b=220, c=52.8`

猎手狼：`a=210, b=105, c=25.2`

`_level = sqrt(hardA + hardB * score);`
`_difficulty = difficulty * densityDifficulty; // densityDifficulty == 1 / pow(1, 0.25)` difficulty 就是这波的 hardness

`hpRate = _difficulty;`

`hpMax = (hpMaxA + hpMaxB * m_level + hpMaxC * m_level * m_level) * hpRate;`

代入计算：难度系数 1.1，进度1599。

```
_level=83.52
hpRate=_difficulty=1.1
hpMax=503271
```

### `hit`

参数：`bullet, nextEffectRate, isAoe`

按照下面的顺序进行运算，`nextEffectRate` 简称 NER。

1. 如果连 AOE 都打不中，则退出。

2. 如果有伤害倍率修正，则 NER 根据狼的陆/空乘上对地、对空加成。

3. 在倍率修正的基础上计算伤害。`damage = bullet.damage * nextEffectRate / defense`。这里考虑了防御系数。

4. 如果有暴击属性（`Crit`），考虑暴击抗性，计算暴击率（概率乘抗性修正，不受 NER 影响，对空不增加暴击率）和暴击伤害。如果暴击，还会让 NER 得到一个增幅。

5. 计算抗性减免伤害（`Resistance`）。减少的伤害会被限定在 $[1, \mathrm{maxHP}]$ 范围内，后者为一个参数，暂不知作用。将减去的伤直接归入伤害。

6. 处理灵魂治愈（`Link`），扣除自身所受伤害。

7. 调用 `injured` 结算伤害。

8. 如果打死狼，攻击的塔经验份额 +20。

9. 粘滞效果（`Slow`）（来自元宵、反应堆）。乘上 NER，获得减速效果 `STATUS_SLOW`，与抗性相抵后，计算移动速度：`_value = lastSpeed * (1 - slowRate * (1 - rsValue))`，其中 `rsValue` 为减速抗性，但这里实际减速又和 NER 无关就很迷。

10. 破甲效果（`ReducedDefense`）。获得一个 $\mathrm{reducedDefenseRate}\times \mathrm{NER}$ 的减防效果。

11. 毒效果（`Poison`）。获得一个 $\mathrm{poisonRate}\times\mathrm{damage}\times\mathrm{NER}$ 的毒效果。这里 `damage` 是子弹原始伤害，不受防御、抗性、暴击等影响。但是状态反馈的伤害需要在后续结算。

12. 冰火/灼冷效果（`BurnCold`）。获得一个值为 $\mathrm{burnColdValue}\times\mathrm{NER}$ 的效果（`BurnColdStatus`）。如果是冰减速，计算新速度：`_value = lastSpeed * (1 - bcs.cold * (1 - _rsValue))`。同样速度不会为负。注意，被冰击中会导致速度直接乘上一个倍率，且抗性不影响状态值。

13. 击退效果（`BeatBack`）。抗性与概率、距离相抵。NER 影响概率，不影响距离。计算击退到的位置，并产生一个平移事件。

14. 沉默效果（`Silence`）。抗性与概率、持续时间相抵。NER 影响概率，不影响持续时间。获得一个沉默状态。

15. 晕眩效果（`Vertigo`）。抗性与概率、持续时间相抵。NER 影响概率，不影响持续时间。获得一个晕眩状态。

16. 威吓效果（`Intimidate`）。抗性与概率、持续时间相抵。NER 影响概率，不影响持续时间。获得一个 Intimidate 状态。

17. 诅咒效果（`Intimidate`）。因为没有概率和抗性，这个效果就很简单。直接挂上一个对应持续时间、诅咒能量的诅咒效果。

18. 诅咒状态（`STATUS_CUSS`）。唯一一个在这里结算的。如果当前被诅咒，那么要累加一个数值，暂不了解其来源。

补充一下诅咒效果。有该效果的子弹命中后就会使狼获得诅咒状态，但诅咒状态不会叠加，只会让 `statusValue` 取新旧最大，计时则按第一次的来。被攻击的狼若有诅咒状态，则伤害计数器增加该状态的 `statusValue`。状态衰减而移除诅咒状态后，造成累积伤害，给 1000 范围内的狼施加 2s 沉默状态（这里范围判定考虑了高度为自己离地高度，而飞行高度是 1100，也就是说大部分情况下，陆空狼沉默独立，除非空狼触发，而范围内陆狼很高）。获得沉默状态时会立即停止施法。

### `stepMove`

狼行为的核心函数。按以下顺序执行逻辑：

1. 如果血量小于等于 0，退出。
2. 移动步数 `aliveStep` 自增 1。
3. 如果 `aliveStep == 25` 且没有分身，且自己是 boss 或随机 boss，则显示红色感叹号。
4. 如果 `aliveStep == 50` 且没有分身，则说话，内容为 Enter 状态。
5. 如果 `aliveStep % 500 == 200` 且没有分身且为绿、黄血，则说话，内容为 Idle 状态。
6. 如果有到羊村的路径，且距离为 3，且不在说话，则说话，内容为 Invade 状态。
7. 如果是分身且分身到期，则死亡，执行 `dead()`，结束。
8. 如果当前施法 `castEvent` 存在，则检查是否前摇完成，如果准备完成则施法，如果血量非正则结束。
9. 如果有空降技能 `AirborneSkill`，且高度大于 0，处理一帧降落。如果此时高度小于等于 0，则开始移动，然后依次执行 `jostle()` 和 `startMove()`。否则继续下降，设置摇晃角为 `sin(aliveStep / 10) * 10`。
10. 如果垂直地面方向速度 `heightSpeed` 不为 0（因弹簧作用而在空中），匀速运动。如果超过弹射高度上限 8000，移动到上方同高度处，坐标在一个半径为 400 的正方形区域内随机取，下降速度设为 500。否则如果高度小于等于 0，表明已经落地，开始移动，依次执行 `jostle()` 和 `startMove()`，并且如果不是重型，获得一个 1s 的晕眩效果。其他情况，获得一个向下的 $20\mathrm{u}/\mathrm{tick}$ 加速度。退出函数。
11. 如果有 `SLOWF` 技能，调用 `startSlowf()`，并获得一个 `STATUS_COLD_SLOWF_M` 状态。（暂不了解效果）
12. 调用 `checkShift()` 检查并处理平移，如果发生平移则退出函数。
13. 如果正在施法，方向数自增 1。
14. 如果状态 `STATUS_MOVE` 值为 0，则退出。
15. 如果当前地图 `isReturn`（不明含义），则调用 `returnMove()`，结束。
16. 如果有空降技能且高度大于 0，表明已经处理完成，退出函数。
17. 如果有晕眩状态 `STATUS_VERTIGO`，退出。
18. 如果有状态 `STATUS_INTIMIDATE`，调用 `returnMove(false)`，退出（含义不明）。
19. 路径步数自增 1。如果大于等于阈值 2500（相当于走了 100s），则重新寻路。
20. 如果没有路径，则调用 `stopMove()` 停止移动，退出。
21. 如果根据路径已经到了出口，调用 `invasion()` 进村，结束。
22. 计算当前位置到下一个路径点、终点的坐标差。如果到终点距离小于 200，则调用 `invasion()` 进村，结束。
23. 调用 `checkTeleport(_distance,_stepLength)` 检查并执行传送。如果发生传送，则退出。
24. 处理坐标移动 `checkMove(_currentPoint,_aimPoint,_distance,_stepLength)`。
25. 如果不会飞，且在传送带上，调用 `startConveyer` 受到传送带速度影响。

#### `startMove`

调用 `stopMove()`，向走过的路径加入当前位置，调用 `findPath()` 寻路，并把 `STATUS_MOVE` 的状态值设为 1。

#### `stopMove`

清除路径，并把 `STATUS_MOVE` 的状态值设为 0。

### `dead`

在清除分身、受伤致死、作为分身进村或分身时间到时调用。分身不会进村。

如果自身不是分身，进行以下判断：

1. 清除所有分身。
2. 说话。
3. 如果有自爆技能 `SuicideSkill`，移除所有状态获得自杀状态 `STATUS_SUICIDE`（持续时间 0.5s），标记延迟清除。
4. 如果有重生技能 `ReliveSkill` 且有剩余重生次数，移除所有状态获得重生状态 `STATUS_RELIVE`（持续时间 8s），标记延迟清除。
5. 如果有转身技能 `ReincarnateSkill` ，移除所有状态获得转生状态 `KIND_REINCARNATE`（持续时间 5s），标记延迟清除。
6. 如果延迟清除，血量设为 -1，调用 `stopMove()` 停止移动，结束。

如果执行到这里，即没有死亡技能且不是分身，则调用 `stopMove()` 停止移动，将自身从波中清除。

### 寻路

#### `findPath`

1. 如果未指定移动方式 `moveMode`，则根据自身是否飞行来设定。
2. 记录临时坐标点 `_tempPoint`：如果已有路径，则其值为下一个路径点，否则为当前坐标点。
3. 调用 `clearPath()` 清除路径。
4. 遍历所有出口（村门口），以 `_tempPoint` 为源点，村口坐标为目标点，执行 `OptimizeAStar` 算法获取一条路径。把各路径中开销最小的作为自己的路径。
5. 如果 `_tempPoint` 不是当前坐标，则将其插入到路径列表的开头。
6. 调用 `setPath(_path,_moveMode)` 设置移动路径。

#### `setPath`

1. 调用 `clearPath()` 清除路径。
2. 如果未指定路径，退出。
3. 如果 `moveMode` 不是 `MAP_CHECK`（检查模式），则遍历指定路径的每个点，将 `costMap` （地图寻路开销）在这些点的值减去自己的 `charm` 值。
4. 将自身路径设为指定的路径，并将 `pathStep` 置为 0。

#### `clearPath`

1. 如果自身没有路径，退出。
2. 遍历当前路径的每个点，将 `costMap` 在这些点的值加上自己的 `charm` 值，即复位。
3. 删除路径 `this.path <- null`，同时速度置零 `this.lastSpeed <- 0` 。 

#### `OptimizeAStar` 寻路算法

##### 常量定义

直线段和传送的 cost 都是 100，对角线的 cost 是 141。

最大寻路尝试 `m_maxTry` 为 15000。

##### `initMap` 初始化地图信息

从关卡地图中获取 `floorMap, airMap, costMap, teleportLib`。这几个相关函数有多次调用。前两个就是二维 `bool` 数组，记录每个位置是否能经过。得到的 `costMap` 初始各项为 0。

##### `setMap` 设置寻路层

根据 `_mapChoice` 把 `m_map` 赋值为对应的地图层，同时初始化地图尺寸参数。

##### `find(p_startX, p_startY, p_endX, p_endY, _mapChoice)` 主要函数

先调用 `setMap` 设置寻路层。

如果起点和终点一样，则返回这条平凡路径。

然后就是在 `maxTry` 限制内做寻路了。如果找到目标则调用 `getPath` 获取 `Path` 对象。

##### `getArounds` 获取相邻点

这个函数在 `find` 内被调用。

值得一提的是传送阵的检查。另外一提，很显然它只检查 4 个方向。顺序是右左下上。

##### `getPath` 生成 `Path` 对象

没什么好说的，得到的路径中的坐标点按自然顺序排列。`Path` 类就是一个包括路径数组和开销 `cost` 的简单结构。

#### 寻路总结

寻路的核心就是 charm，不涉及具体狼的类型、血量分布。但是因为狼的出现顺序、调用寻路顺序的不确定性，实际路径显得很复杂。

用通俗的语言讲，每个格子有一个开销。一个狼寻路的时候，找到一条路，然后对这条路上的开销进行加或减，影响后续单位的寻路。`charm` 为正的狼会把后面的狼的路径吸引过来，为负的狼则会排斥。



#### `speed` 速度获取

`_speed` 最初值为该单位的基础速度。然后进行修正（`_rsValue` 均为对应的抗性）：

1. 如果有减速状态（`STATUS_SLOW`），修正：`_speed *= 1 - _status.statusValue * (1 - _rsValue);`
2. 如果有灼冻状态（`STATUS_BURN_COLD`），且表现为冰，修正：`_speed *= 1 - _bc.cold * (1 - _rsValue);`
3. 如果有狂奔状态（`STATUS_RUN`），修正：` _speed *= 1 + _status.statusValue;`
4. 让速度与上一帧混合：`_speed = max(1, _speed * 0.1 + this.lastSpeed * 0.9);` 当前帧计算的速度只占 10% 比重，但在影响速度的状态保留的情况下，随着连续计算，速度值会越来越接近理想值。
5. 最后将 `lastSpeed ` 设为 `_speed ` 并作为结果返回。

由于这个函数每帧只执行一次，所以速度计算没有问题。

对于 50% 抗冰，单次冰提供的减速效果最大是将速度降到 63%。



### `eventSkill`

1. 如果死亡且没有额外命，退出。

2. 如果 `resHeight` 大于 0，即在空中垂直移动，则退出。

3. 如果当前波不存在或者 `isReturn`，或存活的狼不存在，退出。

4. 如果是分身，或者没有状态，退出。意味着分身不会施放技能。

5. 计算 `canCast`。只要血量小于等于 0，或有沉默、晕眩、施法状态，或在传送，其值都是 false，否则为 true。

6. 遍历每个技能，如果当前不能施法，让该技能预热并冷却。否则判断（技能前都会调用 `checkEvent` 进行判断）：

   -  狂奔 `RunSkill`。获得一个狂奔状态 `STATUS_RUN`。

   - 分身 `MirrorSkill`。以当前位置为中心，750 为距离分布。分身继承了自身的技能，加入到该波狼列表中。自身速度置零，脱离瞄准，并且移除所有状态。

   - 召唤 `SummonSkill`。调用 `startCast` 加入队列。

     `castSummon`：按照前后前后的顺序、间隔 750 分布召唤的狼，和自身同级，血量倍率为 1，但最大血量额外乘上倍率参数（强度）。加入到狼列表。注意，血量跟难度系数无关。

   - 乌云 `CloudSkill`。先找到范围内最近的没有被封的、实力（Ability）不低于平均值一半的塔，调用 `startCast` 加入队列。

     `castCloud`：使目标塔（若存在）获得乌云状态 `STATUS_CLOUD`。

   - 群疗 `CureSkill`。调用 `startCast` 加入队列。

     `castCure`：获取范围内的狼，调用 `cure` 对其按比例回血。

   - 闪烁 `BlinkSkill`。有路径时才执行，调用 `blink()` 闪烁跃进。

   - 隐身 `HideSkill`。获得一个隐身状态 `STATUS_HIDE`。

   - 护盾 `ShieldSkill`。调用 `startCast` 加入队列。

     `castShield`：找范围内血量比例最少的未获得护盾的狼作为目标，如果找不到（技能范围不大于 0 也算也找不到）则目标是自己。目标一个隐身状态 `STATUS_SHIELD`。

   - 嘲讽 `SneerSkill`。强行更改范围内塔的攻击目标为自己（也就是说只要脱离攻击范围或者手动瞄准就失效）。自身速度置零，获得一个护盾状态 `STATUS_SHIELD`。

   - 变身 `TransformSkill`。调用 `startCast` 加入队列。

     `castTransformSkill`：生成一个新狼（继承自身等级、位置，血量倍率为 1），把自身清除掉。

   - 灵魂治愈 `LinksSkill`。自身活获得 `STATUS_LINKS` 状态，范围内未受同类技能影响的的狼获得 `STATUS_LINKS_2` 状态。

技能有一个 `warmupAndCooldown` 机制，`warmup` 指第一次发动冷却时间。

技能施放的条件：冷却好了且不在前摇中，自己活着且血量在规定的范围内，然后有一定概率才施放成功并进入冷却，失败则在下一帧继续尝试。

#### 乌云

机制描述：先找到范围内最近的没有被封的、实力（Ability）不低于平均值一半的塔，然后判断条件，成功则施放。

有多个变种：`Cloud_A, Cloud_B, Cloud_C, Cloud_Z1, Cloud_Z2, Cloud_Z3, Cloud_Z4, Cloud_Z5, Cloud_Z6`。A,B,C 是初级、中级、高级。概率上，初中高级为 0.2，Z1,Z2,Z3 为 0.2，Z4 为 0.3，Z5,Z6 为 0.6。老二的是 Z6，可能因此乌云频率特别高。

塔平均实力的计算（墙不算塔）：所有塔实力之和除以塔数量。每个塔的实力按照下面公式计算：

$$\mathrm{ability}=\begin{cases}  
0 & 镶嵌塔（无宝石） \\
\mathrm{level}\times (0.8 + \mathrm{gemLevel} / 5)\times 2 & 镶嵌塔（有宝石）\\
\mathrm{level}\times (1 + \mathrm{gemLevel} / 10) & 其他塔 \\
\end{cases}$$

其中宝石等级为 0, 1, 2, 3, 4, 5。



## 所有基本单位

### `addStatus`

增加状态。状态表是一个以状态 id 为键值的字典套一个数组。

如果当前没有相同 id 的状态，则把该状态加入状态表，并判断：

- `STATUS_VERTIGO` 晕眩（仅狼）：停止移动，并打断施法。
- `STATUS_SILENCE, STATUS_INTIMIDATE` 沉默和一个未知的（仅狼）：打断施法。
- `STATUS_HIDE` 隐身（仅狼）：播放隐身动画。
- `STATUS_CLOUD` 乌云（仅塔）：让塔休息。

如果当前已经有同名状态：

- `STATUS_POISON, STATUS_REDUCED_DEFENSE, STATUS_SLOW, STATUS_SHIELD` 中毒，减防，减速，护盾：如果该状态数组里有 `statusValue` 相同的状态，`statusTime` 改为两者最大值，否则把新状态加入数组，并按 `statusValue` 降序排列。这可以解释多个中毒状态并存时，只有最强的会产生伤害。
- `STATUS_BURN_COLD` 灼冻：数组有唯一元素，`statusValue` 直接叠加。
- `STATUS_SILENCE, STATUS_CLOUD, STATUS_DARK` 沉默，乌云，未知：`statusTime` 设为新旧最大值。
- `STATUS_CUSS` 诅咒：`statusValue` 设为新旧最大值。

### `removeStatus`

根据 id 移除状态，应该只针对没有多个同名状态的状态。

- `STATUS_CAST` 施法（仅狼）：结束施法标识。

- `STATUS_VERTIGO` 晕眩（仅狼）：恢复移动。

- `STATUS_HIDE` 隐身（仅狼）：如果不在传送，则播放现身动画。

- `STATUS_CUSS` 诅咒：受到对应伤害，使 1000 范围内狼获得沉默状态。

- `STATUS_RELIVE` 复活：调用 `startRelive()`。

  将血量设为最大血量的一定比例，调用 `startMove()` 开始移动。如果有飞行技能，设置高度为飞行高度。

- `STATUS_SUICIDE` 自爆：调用 `startSuicide()`。

  使范围内塔获得乌云状态。如果没有重生状态，执行最终死亡逻辑（跟 `dead()` 最后的一模一样）。

- `STATUS_REINCARNATE` 转生：调用 `startReincarnate()`。

  对于每个转生生成的狼，用 `getShiftSubPos` 设置其坐标。如果自身能飞行但是转生狼不能飞行，对其调用 `jostle()`。将其加入到波和显示层。最后清除自身。

- `STATUS_CLOUD` 乌云（仅塔）：调用 `ready()` 重置状态。

最后删除该状态，并 `removeBuffEffect()`，即移除特效。

### `removeAllStatus`

对所有状态，如果不是沉默或自爆，则调用 `removeStatus` 将其移除。

### `statusDecay`

对自身的所有状态逐个判断。这里存在嵌套，一个 id 下有一个数组存多个状态。

- `STATUS_POISON` 中毒（仅怪物）。每 5 个 status_tick 的第 0 个结算一次。考虑抗性后，直接造成伤害。
- `STATUS_BURN_COLD` 灼冷（仅怪物）。每 5 个 status_tick 的第 2 个结算一次。如果 `statusValue` 大于阈值 4，考虑抗性，造成对应燃烧伤害。否则如果该值大于等于 -4，状态清空。最后将状态值减半。
- `CUSS` 诅咒，`SUICIDE` 自爆，`RELIVE` 重生,`REINCARNATE` 转生。如果 `statusTime` 小于等于 0.2，则移除状态。
- `STATUS_COLD_SLOWF` 减速光环（仅塔）。如果塔在某个拥有减速光环（暂译）的狼的影响范围内，保持该状态。
- `STATUS_LINKS_2` 灵魂治愈。如果扛伤害的怪死了，该状态清零。

接下来遍历该状态组所有状态，将其剩余时间减少，删除过时项。如果该状态组无状态，则 `removeStatus`，否则 `addBuffEffect`，具体待研究。注意灼冷效果持续时间无限，因为它是受状态值控制的。

## 弹簧板

速率为 20（相当于间隔 5 秒），最大弹起数为 5。一个弹簧的弹射目标格是固定唯一的，在所有可走格（`canWalk`）中随机选（但这是假的）。实际情况是，狼被弹到最高处后，找到地图最后一个弹簧板，获取它的随机弹射目标点。

这个类只控制自己的行为，狼如何被弹起在狼的行动逻辑中处理。



# 杂项

## 杂项

### 苦工与力量

升到 $L+1$ 级的升级经验：$2L^3+3L^2+4L+20$。 

抓苦工所需银币：$C=(L+7)\times P$，其中 $C$ 为银币数，$L$ 为等级，$P$ 为静力量（不包括大力锤）。

玩家等级力量：$P=0.015L^2+0.8L+2$（四舍五入取整）

### 一些参数

狼技能参数：`[warmup, cooldown, chances, eventType, duration]`

其中 eventType 为何时能释放，1 为红血，4 为满血



火山参数：`[血量比例, 最大燃烧伤害，乌云时间]` 

反应炉参数：`[减速时间，减速效果值，冰效果值，直接伤害，塔减速时间，塔减速比例]`



### 关于出怪

目前可以肯定的是，一波的总 pop 一定达到上限



### 竞技场抽奖

数据中的第0个出现在第3个，第1个出现在第1个，第2个出现在第2个

下面记录数据中的出现的位置

```
显示顺序-实际顺序
-231
-213
-231
-231
213-132
132-213
213-231
空了一次
123-231
231-213
```

然而这个并不重要，你拿到的永远是后端给你的第一个

你找到的规律都来自洗牌算法：排序，但是比较大小结果随机。

### 升级耗时

每级的 buildValue 之和除以总力量



### 宝箱猜想

据说金宝箱中银币是 [4000, 7000) 的随机数，10% 额外出 1 或 2 个积分。物品上，10% 出碎片（蓝紫的概率较高），10% 出晶体，15% 出 1 级陷阱， 10% 出 2 级陷阱，10% 出 3 级陷阱，5% 出 sl，10% 出宝石，10% 出精华，15% 出不明物体



### 银币数据拟合记录

拉卡维银币奖励：$y=b\sqrt[3]{a+x}$，$x$ 为进度，拟合出 $a=18.8893$，$b=198.02957$

发现 $a\approx hardA/hardB$，函数关系写成：

$y=k\sqrt[3]{h_a+h_bx}$，拟合出 $k=128.0259$，其中 $h_a=70, h_b=3.7$

西利 $k=136.044$，$h_a=80, h_b=4.1$，但是没有前期的数据

假设有问题？拉卡维所有数据上来拟合，两参数假设中，$a=198.016446$，与 $70/3.7=18.9189$ 差距还是有的

把最初假设写成 $y=k\sqrt[3]{(b/k)^3(a+x)}$

#### 研究历程

最初是在 Excel 上记录数据（从打拉卡维才开始记录），并尝试作图来拟合，发现该图银币的立方与进度呈线性关系，于是在 python 进行拟合，使用假设函数 $y=a\sqrt[3]{b+x}$，得到 $b=18.8893$，$a=198.02957$，发现 $a\approx \mathrm{hardA}/ \mathrm{hardB}$，于是把函数关系写成：$y=k\sqrt[3]{h_a+h_bx}$。经过数据不断补充，最小二乘拟合出 $k=128.02611156$，后来考虑到取整的不连续性导致误差，又使用三分法，求出 $128.09041268173095$（最终拟合数据有点问题，可能是因为数据有污染，之前有求出拟合度很好的 $k=128.025930315$）。

在拉卡维通关前，也尝试拟合各地图的经验、拉卡维以外图的银币。之前没有记录，都是从自己录的视频里找找到的，共 7 张图，可惜进度偏后，数值变化率小，误差可能较大。应用数据拟合，发现虽然函数关系式没有问题，但不同地图的 $k$ 值都不一样，而且很丑，显然不是初始给定的常数，而应该是一系列计算结果。用  $y=(a+bx)^c+m$ 拟合出经验的函数关系式后（经验比较难拟合，因为增长率比银币慢多了），发现经验和银币成正比，不过比例系数在各个地图不同，拉卡维则约为 $5.61$。因此把探究重心放在了 $k$ 值上。

之后就是对 $k$ 值涉及参数的猜测，把已有的数据列出来，进行控制变量法比较。

<img src="https://i.loli.net/2021/09/20/nSWJ6C8Fj4aUA9L.png" style="zoom:80%;" />

首先考虑到的是难度系数。一方面，可以排除掉 `hardA` 的影响，因为 m9A 和 m9B 有相同 `hardA`，但 $k$ 不同。另一方面，虽然 m8B, m9A, m9B 有相同的 `hardB`，但是 m9A 的 $k$ 不一样，也不少误差导致的，所以不可能仅仅是 `hardB` 有影响。这时陷入了瓶颈。

最终导致突破的还是一个大胆猜想：前端得到的部分配置数据没有实际使用，不是因为懒得去冗余，而且为了保证数据对称性，前后端使用同样的配置文件。在这样的假设下，银币参数都来自配置文件，而且因为不同的图该参数不一样，应该是 `umaps` 下的。开始排查数据文件，每个地图的数据中有 `pop_max`，`pass_score`，`interval`，`yield_val`，`hard_ness`，后两个是难度系数但是之前已经被否决了。`interval` 影响银币也不靠谱，于是锁定到前两个。

还是假设缺的是一个比例系数。先想到的是 `pass_score`，对 `m8B` 和`m9C` 的 `pass_score` 和 $k$ 的比例进行比较，发现几次根号都不符。然后又注意到 `pop_max`，发现正好都满足 $1.06$ 这个比例系数。于是将 $k$ 除以 $\mathrm{populationMax}$，惊喜地发现各图结果相近，猜想得到验证。

<img src="https://i.loli.net/2021/09/20/efuqxXWtvH5ITZ1.png" style="zoom:80%;" />

但是新的麻烦问题又来了，这个商 $2.06$ 还是很丑，显然不是简单的平方、开方得到的。进一步观察发现，`pop_max` 越大，商越小。为了进一步确认，用 co 的各地图 boss 波银币数据进行计算，绘图。

<img src="https://i.loli.net/2021/09/20/8Et37MG9X2iAmIF.png" style="zoom:80%;" />

由右上图表可见，如果不考虑巴罗村，$k$ 和 $p$ (`max_pop`) 呈线性关系，且比例系数近似为 $2$。这样得出关系式 $k=2p+3.8745$。但是拟合度还是不够高，因为我们知道，$k$ 的很小扰动都会影响到最终银币计算值。这里埃特纳和莫诺雷的偏差尤其大。

<img src="https://i.loli.net/2021/09/20/DQZ6upXtOvH4IlP.png" style="zoom:80%;" />

后来发现奇怪的误差是数据错误导致的……巴罗、埃特纳、莫诺雷、奥兹玛、烈焰熔炉的银币都是错的（后来发现苏城也少了 1）（再后来拟合经验的时候，发现坦克尔和西利的经验多记了 10），修正后确定 $k$ 应该只和 $p$ 有关，考虑到四舍五入的影响，求出可能的 $k$ 的上下界 $k_h, k_l$，并作图 $y=ax+b$。剔除银币较少的数据，只保留银币大于等于拉帕斯村的 $1760$ 的数据，由 Excel 趋势线得，对于 $k_l$，$a=2.004010, b=3.754000$；对于 $k_h$，$a=2.003717, b=3.831104$。

<img src="https://i.loli.net/2021/10/09/MmD4tv8qlFIO9Vi.png" alt="QQ截图20210920190006.png" style="zoom:80%;" />

<img src="https://i.loli.net/2021/10/09/y48IhUstAjivxmC.png" alt="QQ截图20210920190033.png" style="zoom:80%;" />

<img src="https://i.loli.net/2021/10/09/goTt3plkDwuB5mc.png" alt="QQ截图20210920190046.png" style="zoom:80%;" />

考虑配置文件中的 `pk_gold_factor=2, pk_exp_factor=3.5`

那个 $k$ 究竟是什么？？

如果直接拿 $y=k\sqrt[3]{h_a+h_bx}$ 去拟合，对于 m8C，有多个点拟合出的值比实际值偏小（不排除数据记录错误），那么考虑加个平移？

$k$ 应该是个关于 $p$ 的函数，参数弄出比较好的，但还是很丑

对于 $k=ap+b$，银币、经验对应的 $b$ 的比值接近 $2/3.5$

银币：$k_g\approx 2.0045p+3.7475$

经验：$k_e\approx 0.2624p+6.5484$

新发现：

$3.7475\approx 2\times5^{0.39}=3.746522..., 6.5484\approx 3.5\times5^{0.39}=6.556414...$

$0.2624\approx 0.04 \times 6.5484$

$k_e=(0.04p+1)\times3.5\times 5^{0.39}$

但是走不通？经验拟合效果并不是很好

$2.0045 \approx 5.948^{0.39}, 0.2624 \approx 0.2 \times 2^{0.39}$

0.53502955541165913345764418305831

考虑再作一个假设：银币和经验公式系数差别的原因仅在于 `factor` 不同。

这个问题待解决

### 所有主要用到 `round` 四舍五入取整的地方

先吐槽一下好多整数值没有用 `int` 存，非要做取整校验。应该是 `AS2` 的后遗症吧、

1. `unkennelDelayNum` 出怪间隔的 tick 数。
2. 计算所有狼、塔的实力，结果取整。竞技场的狼、塔实力转换经验，做了两次取整（实力二者取较小时，乘上系数后）。
3. 计算 `pathNum`。
4. 一波狼的平均血量。
5. 狼、塔的等级经验、实力。塔的 `valueCost`、`sellCost`、建造时间、建造花费（这个是累加了多级的花费后取整）。
6. 狼受到的毒、诅咒伤害。
7. 塔攻击力、攻击频率基础值的计算。再计算墙的修正影响时，用的是向上取整。
8. 陷阱攻击频率、攻击力（按比例造成伤害）的计算。
9. 墙的 `buildValue`、造价、卖价、实力、建造时间。

可以推测经验、银币奖励也是四舍五入取整。

### 对随机boss的一个猜想

 服务端记录距离上次随机boss过了多少波 `random_boss_item`

猜测这个数越大，出随机boss概率越高，也就是保底。

### 一些参数

```
        "random_boss_prob": 0.05,
        "exp_gold_power": [
            [
                2,
                3
            ],
            0.39
        ],
         "visit_exp_factor": [
            2,
            0.4,
            0.8
        ], //猜测是2+[0.4,0.8]*lv      
        "conveyer_speed": 12,
        "bonus_fids_max_num": 10,
        "mixture_gem": {
            "base": 100,
            "max": 19,
            "val": 100
        },
        "visit_fids_min_num": 5,
        "bonus_fids_factor": [
            500,
            250
        ],
		"user_explev": {
            "c": 3,
            "a": 20,
            "d": 2,
            "b": 4
        },
        "random_boss_minitem": 15,
        "random_boss_maxitem": 40,
        "visit_fids_factor": 3,
        "visit_gold_factor": [
            100,
            18.5,
            22.5
        ],
        "slave_max_invite_score": {
            "c": 150,
            "a": 50,
            "b": 4
        },
        "user_power": {
            "c": 0.015,
            "a": 2,
            "b": 0.8
        },
        "visit_fids_max_num": 60,
        "slave_build_max": {
            "b": 1,
            "a": 4
        },       
```

### 关于间谍狼的猜想

用 $l$ 表示等级，$G$ 表示银币，$E$ 表示经验，则满足（结果四舍五入）

$$18.5l+100 \le G \le 22.5l+100$$

$$0.4l-2 \le E \le 0.8l-2$$

但是有数据不满足

### 上面那个 `slave_max_invite_score`

`getSlave_max_invite_score <- int(_a + (_slave_max - _b) * _c)`

其中 `_a=50, _b=4, _c=150 `，`_slave_max ` 为玩家当前最大苦工数

### 从数学角度看求解狼组成

设有 $m$ 种狼，一共有 $N$ 个，第 $i$ 种狼的 pop 为 $p_i$，数量为 $x_i$，血量为 $h_i$，满足约束条件：

$$\begin{cases}  
\sum_{i=1}^mx_i=N \\
\sum_{i=1}^mx_ip_i=P \\
\mathrm{round}(\sum_{i=1}^mx_ih_i/N)=H \\
\end{cases}$$

$x_i$ 为自然数，$p_i,N,P,H$ 为正整数，$h_i$ 为正实数。其他量已知，求解 $x_i$。

### 计算数量分布概率

动态规划，单独计算每种怪

$f[i][j]$ 表示已有 pop 为 $i$，这种狼有 $j$ 个的状态的概率。

初值 $f[0][0]=1$。需要求 $f[P][j]$。

$f[i][j]=\sum_k{f[i-p_k][j]q_k}+f[i-p_0][j-1]q_0$

### `buildCost` 和 `valueCost`

设塔 `n` 级的造价为 $f(n)$（小数，未取整），则

逐级升级实际总造价：$\displaystyle{\mathrm{totalCost}(n)=\sum_{i=1}^n\mathrm{buildCost}(i)=\sum_{i=1}^n[f(i)]}$

显示的总造价：$\displaystyle{\mathrm{valueCost}(n)=[\sum_{i=1}^nf(i)]}$

其中 $[x]$ 为四舍五入取整。

### 群友提供的噩梦箱数据

菜鸟：1123 就是10波1菜鸟 20波1菜鸟 30波2菜鸟；   3个菜鸟机关 2随机碎片

普通：1122 ； 3初级机关 4随机碎片

实用箱：2晶体 机关忘了应该是4个初级机关 记不清楚了

猜测跟数据里的配置有关

### 塔是否启用的控制

`index > 0` 才能启用，可建造

### 某村噩梦的 pop

```
23
24
24
28
31
28
32
38
41
```

### 求解缺数据图的难度系数

#### 钓鱼岛

数据来自断魂的视频。

进度 600，boss 波根据恶狼将军召唤的飞天狼 5978 血得出 `hardA=80, hardB=2.7`（另解 `hardA=20, hardB=2.8` 舍去）

根据鲤鱼旗狼 39482 血，花狼 39708 血，假设血量系数 $a,b,c$ 满足 $a:b:c=1:0.5:0.12$，试探法求得鲤鱼旗狼 `a=175`，花狼 `a=176`。红太狼不满足作为随机 boss 时的数据，但根据上述假设，得 `a=160`。

根据通关银币 643，经验 157，得出 `max_pop=25`。

#### 泰勒斯

数据来自断魂的视频。

进度 2000，boss 波一个弹簧狼被打大约 8000 血后剩余 373488 血，得出 `hardA=80, hardB=3.7`。

boss 波的第一个光能狼吃 3 发蓝镶嵌、2 发炮、2 次 1522 毒伤害（累计 13044）后剩 370196 血，估计最大血量为 383240。试探得出其血量系数 `a=201, b=100.5, c=50.25`，实际还有一次毒伤害未计入。

根据通关银币 2504，经验 446，得出 `max_pop=62`。

#### 弗兰克

数据来自断魂的视频。

进度 2200，boss 波一个护士被光攻击一次后剩 118236 血，得出 `hardA=80, hardB=3.7`。

根据通关银币 2584，经验 460，得出 `max_pop=62`。

顺便根据 1842 进度的圣诞老狼王 365386 血（假设难度为 1.0），得出其血量系数 `a=420, b=210, c=50.4`。这波奖励 2437 银币，434 经验，验证难度系数。在这波有 3 光能，2 防毒，2 弹簧，3 神偷，5 山贼，除光能外 pop 总和为 59，得出光能狼 pop 为 1？？？

### 噩梦塔经验

噩梦地图的难度系数不同于前线地图，且不同进度段的 `difficultyValue` 不一样。

对于卡西村 87~137 波，每隔 10 波，经验近似满足 $e=(ax+b)(h_a+h_bx)^{0.6}$

这里 $a,b$ 与 `wolf_key` 有关，但是系数很丑。

换了一个思路，既然趋势那么像线性，那就想办法把那个统一的截距找出来。于是经试验得到关系式：

$e=px^{1.2}+1000$

其中 $x$ 是进度（`killed_sum`），$e$ 是总经验， $p$ 是 `wolf_key` 为 $x$ 个位数的波的 pop 数，几个系数均来自配置文件。

检验证实这个公式的正确性。

<img src="https://i.loli.net/2021/10/09/2uM1kzBC3SIg9y4.png" alt="QQ截图20211008221922.png" style="zoom:80%;" />

经验分配机制：按照 offer，求出所有塔产生的 `allOffer`，然后让所有塔按照 offer 比例分配经验（向下取整）。剩下的经验以 1 为单位依次分发给获得经验的塔，发完为止。

噩梦打狼获得银币也进行了数据拟合，满足前线的那个诡异的公式。pop 正常计算，但是 boss 的 pop 算 3。
