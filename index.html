<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <title>TDSheepVillage Tools</title>

    <link rel="icon" href="image/icon.jpg" type="image/x-icon">

    <!-- CSS -->
    <link href="css/normalize.css" rel="stylesheet">
    <link href="css/github.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Lib -->
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="https://underscorejs.net/underscore-min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/marked/2.1.3/marked.min.js"></script>
    <script type="text/javascript" src="js/echarts.min.js"></script>

    <!-- KaTeX -->
    <link href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.css" rel="stylesheet">
    <script defer src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/katex.min.js"></script>
    <script defer src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/copy-tex.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.12.0/contrib/copy-tex.js"></script>

    <!-- My JS -->
    <script type="text/javascript" src="exscore.js"></script>
    <script type="text/javascript" src="sort_table.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="format.js"></script>
    <script type="text/javascript" src="static/wavegen_freq.js" defer></script>
    <script type="module" src="js/InitLoad.js"></script>

</head>

<body>
    <aside>
        <div class="header">羊村数据小工具</div>
        <ul style="padding-left: 0;">
            <li><a data-section="user">玩家数据</a></li>
            <li><a data-section="towers">塔数据</a></li>
            <li><a data-section="wolfs">狼数据</a></li>
            <li><a data-section="umaps">地图数据</a></li>
            <li><a data-section="umap-wolf">前线地图的狼</a></li>
            <li><a data-section="research-notes">研究笔记</a></li>
        </ul>
    </aside>
    <script>
        // 数据加载

        $("aside ul").click(function (e) {
            if (e.target.tagName == "A") {
                switchSection(e.target.getAttribute("data-section"));
            }
        });

        function switchSection(secid) {
            $(`aside a[data-section="${secid}"]`).parent().addClass("active").siblings().removeClass("active");
            $(`section[data-section="${secid}"]`).removeClass("hide").siblings().addClass("hide");
        }

        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                macros: {
                    "\\ge": "\\geqslant",
                    "\\le": "\\leqslant",
                    "\\geq": "\\geqslant",
                    "\\leq": "\\leqslant"
                }
            });
        });

    </script>

    <div class="section-container">
        <section>
            <div><a href="https://github.com/QuadnucYard/tdsheepvillage-tools/tree/master">主页</a></div>
            <div>
                前排提示，本网站使用大量新版本 JavaScript，如果有功能无法使用，请尝试更换浏览器，或者与作者联系。
            </div>
        </section>

        <section data-section="user" class="hide">
            <div class="content" style="cursor: default;">
                <h1>玩家数据</h1>
                <p><label>等级：<input name="level" type="number" min="1" value="1"></label></p>
                <p><label>升级经验：<label name="max-exp"></label></label></p>
                <p><label>力量：<label name="power"></label></label></p>
                <p><label>连升等级：<label name="upgrade-level"></label></label></p>
                <p><label>苦工价格：<label name="slave-gold"></label></label></p>
            </div>
            <script type="module">
                import { InitLoad } from "./js/InitLoad.js";

                InitLoad.ready(() => {
                    let $this = $('[data-section="user"]');

                    $this.find('[name="level"]').change(showData);
                    showData();

                    function showData() {
                        let $this = $('[data-section="user"]');

                        let level = parseInt($this.find('[name="level"]').val());
                        let _power = Math.round((0.015 * level + 0.8) * level + 2);

                        $this.find('[name="max-exp"]').text(((2 * (level + 1) + 3) * (level + 1) + 4) * (level + 1) + 20);
                        $this.find('[name="power"]').text(_power);
                        $this.find('[name="upgrade-level"]').text(Math.floor(level / 4 + 1));
                        $this.find('[name="slave-gold"]').text((level + 7) * _power);
                    }

                });
            </script>
        </section>

        <section data-section="towers" class="hide">
            <div class="content" style="cursor: default;">
                <h1>防御塔数据</h1>
                <p>
                    <label>是否为防线：<input type="checkbox" name="isDefendMap"></label>
                </p>
                <p>
                    <label>塔</label>
                    <select name="tower-id"></select>
                </p>
                <p>
                    <label>宝石</label>
                    <select name="gem-id"></select>
                </p>
                <p>

                </p>
                <p>
                    <label>等级：</label>
                    <input name="level" type="number" min=1 max=100 value=1>
                    &emsp;
                    <label>等级上限：<label name="lev_max"></label></label>
                </p>
                <p>
                    <label>攻击力：<label name="damage"></label></label>&emsp;
                    <label>攻击频率：<label name="rate"></label></label>&emsp;
                    <label>攻击范围：<label name="range"></label></label>&emsp;
                </p>
                <p>
                    <label>升级经验：<label name="expMax"></label></label>
                </p>
                <p>
                    <label>简介：</label>
                <div name="skillInfo" style="line-height: 150%;"></div>
                </p>
                <p>
                    <label>ability: <label name="ability"></label></label>
                    &emsp;
                    <label>power: <label name="power"></label></label>
                    &emsp;
                    <label>buffEffect: <label name="buffEffect"></label></label>
                    <br>
                    <label>buildValue: <label name="buildValue"></label></label>
                    &emsp;
                    <label>buildCost: <label name="buildCost"></label></label>
                    &emsp;
                    <label>valueCost: <label name="valueCost"></label></label>
                </p>
                <br>
                <h2>升级计算</h2>
                <p>
                    从<input name="build-from" type="number" min=1 style="width: 3em;" value="0">级到<input name="build-to"
                        type="number" min=1 style="width: 3em;" value="1">级
                    <br>
                    苦工总力量：<input name="build-power" type="number" min=1 style="width: 5em;" value=1>
                    <br>
                    需要时间：<label name="build-time">NaN</label>
                    <br>
                </p>
                <p>注：升级经验为塔下一级的 buildValue 值</p>
            </div>
            <script type="module">
                import { GlobalData } from "./js/ado/GlobalData.js";
                import { Tower } from "./js/module/unit/Tower.js";
                import { GameMap } from "./js/module/map/GameMap.js";
                import { GemItem } from "./js/module/item.js";
                import { InitLoad } from "./js/InitLoad.js";

                InitLoad.ready(() => {
                    let $this = $('[data-section="towers"]');

                    $this.find('[name="tower-id"]').html(
                        _.map(GlobalData.$_towerAtt_Obj, (t, k) => [k, t["name"]])
                            .maps(t => `<option value=${t[0]}>${t[1]}</option>`)
                    );
                    $this.find('[name="gem-id"]').html(
                        [["", "无"], ..._.map(GlobalData.$_global_properties["gem"], (t, k) => [k, t["name"]]).sortBy(0)]
                            .maps(t => `<option value=${t[0]}>${t[1]}</option>`)
                    );

                    $this.find('[name="isDefendMap"], [name="tower-id"], [name="gem-id"], [name="level"]').change(showData);
                    $this.find('[name="isDefendMap"], [name="build-from"], [name="build-to"], [name="build-power"]').change(calcBuildTime);

                    GameMap.currentMap = new GameMap("m1");

                    showData();
                    calcBuildTime();

                    function showData() {
                        let $this = $('[data-section="towers"]');

                        let tower_id = $this.find('[name="tower-id"] option:selected').val();
                        let gem_id = $this.find('[name="gem-id"] option:selected').val();
                        let level = parseInt($this.find('[name="level"]').val());

                        GameMap.currentMap = new GameMap($this.find('[name="isDefendMap"]').prop("checked") ?
                            GameMap.DEFEND_MAP_1 : GameMap.ENDLESS_MAP_1);

                        let towerData = GlobalData.$_towerAtt_Obj[tower_id];
                        let tower = new Tower(tower_id);
                        tower.level = level;
                        if (gem_id != "") {
                            tower.setGem(new GemItem(gem_id));
                        }

                        $this.find('[name="lev_max"]').text(tower.towerData.levelMax);
                        $this.find('[name="damage"]').text(tower.damage());
                        $this.find('[name="rate"]').text(tower.rate);
                        $this.find('[name="range"]').text(tower.range);
                        $this.find('[name="ability"]').text(tower.ability.toFixed(1));
                        $this.find('[name="power"]').text(tower.power);
                        $this.find('[name="expMax"]').text(tower.buildValue(level + 1));
                        $this.find('[name="buildValue"]').text(tower.buildValue());
                        $this.find('[name="buildCost"]').text(tower.buildCost());
                        $this.find('[name="valueCost"]').text(tower.valueCost());
                        $this.find('[name="buffEffect"]').text(tower.buffEffect().toFixed(1));
                        $this.find('[name="skillInfo"]').html(tower.getInfoHtml());

                    }

                    function calcBuildTime() {
                        let $this = $('[data-section="towers"]');

                        let tower_id = $this.find('[name="tower-id"] option:selected').val();
                        let buildFrom = parseInt($this.find('[name="build-from"]').val());
                        let buildTo = parseInt($this.find('[name="build-to"]').val());
                        let buildPower = parseInt($this.find('[name="build-power"]').val());

                        if (buildFrom >= buildTo) {
                            $this.find('[name="build-time"]').text("NaN");
                            return;
                        }

                        let tower = new Tower(tower_id);
                        let buildTime = 0;
                        for (let i = buildFrom + 1; i <= buildTo; i++) {
                            buildTime += tower.buildValue(i);
                        }
                        buildTime = Math.round(buildTime / buildPower);
                        $this.find('[name="build-time"]').text(`${Math.floor(buildTime / 3600)}:${pad(Math.floor(buildTime % 3600 / 60).toString(), 2)}:${pad((buildTime % 60).toString(), 2)}`);
                    }
                });
            </script>
        </section>

        <section data-section="wolfs" class="hide">
            <div class="content">
                <h1>狼数据</h1>
                <p>前排解释：</p>
                <p>pop 为狼在一波中占的容量，一般来说 pop 越大则出现机会越少。</p>
                <p>charm 影响到寻路，charm 为负值越小则其他狼越会排斥它。</p>
                <p>hp_factor 影响血量关于等级增长，是二次函数系数。</p>
                <table class="pure-table" style="font-size: smaller;">
                    <thead>
                        <tr>
                            <th class="sortable">id</th>
                            <th class="sortable">name</th>
                            <th class="sortable">speed</th>
                            <th class="sortable">pop</th>
                            <th class="sortable">charm</th>
                            <th>hp_factor</th>
                            <th>skills</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <script type="module">
                import { GlobalData } from "./js/ado/GlobalData.js";
                import { InitLoad } from "./js/InitLoad.js";
                import { Monster } from "./js/module/unit/Monster.js";

                InitLoad.ready(() => {
                    let $this = $('[data-section="wolfs"]');
                    $this.find(".content table tbody").append(_.map(GlobalData.$_wolfAtt_Obj, (t, k) => k).sort().map(t => {
                        let _wolf = new Monster(t, 0, 0);
                        _wolf.initSkills();
                        return `<tr>
                            <td>${t}</td>
                            <td>${_wolf.monsterData.name}</td>
                            <td>${_wolf.monsterData.speedBase}</td>
                            <td>${_wolf.monsterData.population}</td>
                            <td>${_wolf.monsterData.charm}</td>
                            <td>${_wolf.monsterData.hpMaxA}, ${_wolf.monsterData.hpMaxB}, ${_wolf.monsterData.hpMaxC}</td>
                            <td>${_.map(_wolf.skills, (t, k) => `<p>${getSkillHtml(t)}</p>`).join("")}</td>
                            </tr>`
                    }));

                    function getSkillSign(_skill) {
                        return !_skill.isDebuff ? formatHtml("↑", 0xFF0000, true, "", "monospace") : formatHtml("↓", 0, true, "", "monospace");
                    }
                    function getSkillHtml(_skill) {
                        const _tagColor = 0x4040F0;
                        let _htmlTextArr = [];

                        _htmlTextArr.push(getSkillSign(_skill) + " " + formatHtml(_skill.name, 0x000040, true, "") + "&nbsp;");
                        _htmlTextArr.push(formatHtml(`Lv${_skill.level} `, 0x000040, true, ""));
                        _htmlTextArr.push(formatHtml(`[${_skill.data.id}] `, 0x777777, true, "smaller"));
                        _htmlTextArr.push(formatHtml(_skill.skillInfo, 0x333333, false, "smaller"));
                        if (_skill.skillTag1) _htmlTextArr.push(formatHtml(_skill.skillTag1, _tagColor, false, "small"));
                        if (_skill.skillTag2) _htmlTextArr.push(formatHtml(_skill.skillTag2, _tagColor, false, "small"));
                        if (_skill.skillTag3) _htmlTextArr.push(formatHtml(_skill.skillTag3, _tagColor, false, "small"));
                        return _htmlTextArr.join("");
                        //return formatHtmlBr(_htmlTextArr);
                    }
                });
                $(document).ready(() => sortTable('[data-section="wolfs"] table'));
            </script>
        </section>

        <section data-section="umaps" class="hide">
            <div class="content">
                <h1>地图数据</h1>
                <p>前排解释：</p>
                <p>狼的等级随进度增加而增加。难度系数 hardA 影响初始狼等级，hardB 影响等级增长速率。</p>
                <p>population 影响一波狼的容量。每只狼都会占用一定容量。</p>
                <p>不同随机boss有出现权重。出现率、难度、奖励水平是相对应的，难的比较稀有，奖励也会比较好。</p>
                <script>
                    document.write(marked(`\`unkennelRule\`：-1=RANDOM, 0=SAME_TIME, 1,2,...=FOLLOWED`))
                </script>
                <table class="pure-table" style="font-size: small;">
                    <thead>
                        <tr>
                            <th class="sortable" title="no">No</th>
                            <th class="sortable" title="id">id</th>
                            <th class="sortable" title="name">name</th>
                            <th class="sortable" title="需要等级">needLevel</th>
                            <th class="sortable" title="通关进度(pass_score)">scoreMax</th>
                            <th class="sortable" title="难度系数(yield_val)">hardA</th>
                            <th class="sortable" title="难度系数(hard_ness)">hardB</th>
                            <th class="sortable" title="最大population">population<br>max</th>
                            <th class="sortable" title="狼出场间隔(s)">unkennel<br>delay</th>
                            <th class="sortable" title="狼出场规则">unkennel<br>rule</th>
                            <th class="sortable" title="传送规则">teleport<br>rule</th>
                            <th title="需要通过">passBy</th>
                            <th title="关卡狼列表（方括号中为pop数）">monsterList</th>
                            <th title="随机Boss列表（花括号中显示难度和对应的奖励）">randomBoss</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <script type="module">
                import { GlobalData } from "./js/ado/GlobalData.js";
                import { InitLoad } from "./js/InitLoad.js";

                InitLoad.ready(() => {
                    let $this = $('[data-section="umaps"]');
                    $this.find(".content table tbody").append(GlobalData.$Maps.map(k => ((k, t) =>
                        `<tr>
                            <td>${GlobalData.$Maps.indexOf(k)}</td>
                            <td>${k}</td>
                            <td>${t.name}</td>
                            <td>${t.need_lev || 0}</td>
                            <td>${t.pass_score}</td>
                            <td>${t.yield_val}</td>
                            <td>${t.hard_ness}</td>
                            <td>${t.pop_max}</td>
                            <td>${t.interval}</td>
                            <td>${t.interval_rule}</td>
                            <td>${t.teleport_rule || ""}</td>
                            <td>${t.pass_by.map(u => GlobalData.$_map_Obj[u].name)}</td>
                            <td class="align-left">${t.wolf_proportion.map(t => GlobalData.$_wolfAtt_Obj[t[1]]).map(t => `${t.name}[${t.pop}]`).join(", ")}</td>
                            <td class="align-left">${_.map(t.random_boss?.map(t =>
                            [GlobalData.$_wolfAtt_Obj[t[1]].name, t[2], Object.entries(t[3].properties.card)[0]]).groupBy(0), (t, k) =>
                            `${k}{${t.maps(u => `${u[1]},${GlobalData.$_global_properties.card[u[2][0]].name.takeFrom('^', 1)}*${u[2][1]}`, "; ")}}`
                        ).join(", ") || ""
                        }</td>
                        </tr>`
                    )(k, GlobalData.$_map_Obj[k])).join(", "))
                    $(document).ready(() => sortTable('[data-section="umaps"] table'));
                });
            </script>
        </section>

        <section data-section="umap-wolf" class="hide">
            <style>
                [name=wolf-buttons] span {
                    user-select: none;
                    background-color: #e5eece;
                    border-radius: 4px;
                    margin: 0 .2em;
                    padding: .4em;
                    font-size: smaller;
                }

                [name=wolf-buttons] span:hover {
                    background-color: #f2f7e7;
                }
            </style>

            <div class="content">
                <h1>前线地图的狼</h1>
                <p>
                    <label>地图</label>
                    <select name="umap-id"></select>
                    <label name="umap-diff">难度系数：</label>
                </p>
                <p>
                    <label>该地图的狼：</label>
                    <span name="wolf-buttons"></span>
                </p>
                <p>
                    <label>狼</label>
                    <select name="wolf"></select>
                    <label name="hp-factor">血量系数：</label>
                </p>
                <p>
                    <label>进度</label>
                    <input name="score" type="number" min=0 value=0>
                    <label name="pass-score">通关进度：</label>
                </p>
                <p>
                    <label>难度</label>
                    <select name="diff">
                        <option value=0.8>小菜一碟</option>
                        <option value=0.9>轻而易举</option>
                        <option value=1.0>势均力敌</option>
                        <option value=1.1>有惊无险</option>
                        <option value=1.2>稍有难度</option>
                        <option value=1.3>困难重重</option>
                    </select>
                </p>
                <p>
                    <label>等级：</label><label name="level"></label>
                    <label>最大血量：</label><label name="hpMax"></label>
                </p>
                <div class="hp-chart" style="width: 600px; height: 300px;"></div>
                <div class="chart-area" style="position: absolute; top: 3em; right: 3em; font-size: .8em;">
                    <h2 style="text-align: center;">狼出现频率（按数量，供参考）</h2>
                </div>
                <p>
                    <button name="btn-generate">随机生成一波</button>
                    <label name="wave-info"></label>
                </p>
                <p><input type="text" name="wave-data" spellcheck="false" style="width: 40em;"></p>
                <p><input type="text" name="wave-data-raw" spellcheck="false" style="width: 40em;"></p>
            </div>

            <script type="module">
                import { GlobalData } from "./js/ado/GlobalData.js";
                import { GameMap } from "./js/module/map/GameMap.js";
                import { Monster } from "./js/module/unit/Monster.js";
                import { MonsterManager } from "./js/command/unit.js";
                import { InitLoad } from "./js/InitLoad.js";
                import { Wave } from "./js/module/map/Wave.js";
                import { WaveData } from "./js/command/map.js";

                InitLoad.ready(() => {
                    let $this = $('[data-section="umap-wolf"]');

                    $this.find('[name="umap-id"]').html(
                        _.map(GlobalData.$_map_Obj, (t, k) => [k, t["name"]]).sort((p1, p2) => {
                            return compareNumber(
                                parseInt(/(?<=m).+(?=[A-Z]*)/.exec(isAlpha(p1[0].last()) ? p1[0] : p1[0] + "A")[0], 36),
                                parseInt(/(?<=m).+(?=[A-Z]*)/.exec(isAlpha(p2[0].last()) ? p2[0] : p2[0] + "A")[0], 36),
                            );
                        }).maps(t => `<option value=${t[0]}>${t[0]} ${t[1]}</option>`)
                    );

                    $this.find('[name="wolf"]').html(
                        _.map(_.map(GlobalData.$_wolfAtt_Obj, (t, k) => [k, t["name"]])
                            .groupBy(t => t[1].includes("camp") ? "防线" : (t[0].includes("D_") ? "噩梦" : "前线"))
                            , (t, k) => `<optgroup label="${k}">${t.sortBy(0).maps(s => `<option value=${s[0]}>${s[1].includes("^") ? s[1].takeFrom("^", 1) : s[1]
                                }</option>`)
                                }</optgroup>`)
                    );

                    //初始选择
                    $this.find('[name="diff"]')[0].selectedIndex = 2;
                    $this.find('[name="wolf"] option[value="dahuil"]')[0].selected = true;

                    //事件
                    $this.find('[name="score"]').click(function (e) {

                    });
                    $this.find('[name="pass-score"]').click(function (e) {
                        $this.find('[name="score"]').val(this.innerHTML);
                        calc();
                    });
                    $this.find('[name="btn-generate"]').click(function (e) {
                        let mid = $this.find('[name="umap-id"] option:selected').val();
                        let mlist = generateWave(mid);
                        $this.find('[name="wave-data-raw"]').val(`[${mlist}]`);
                        $this.find('[name="wave-data"]').val(mlist.map(t => GlobalData.$_wolfAtt_Obj[t].name));

                        let diff = parseFloat($this.find('[name="diff"] option:selected').val());
                        let score = parseInt($this.find('[name="score"]').val());
                        let mapData = GameMap.getMapData(mid);
                        let level = Math.sqrt(mapData.hardA + mapData.hardB * score);
                        let totalHp = 0;
                        for (let wolf_id of mlist) {
                            totalHp += (new Monster(wolf_id, level, diff)).hpMax;
                        }
                        $this.find('[name="wave-info"]').text(`共 ${mlist.length} 只狼，平均血量 ${Math.round(totalHp / mlist.length)}`);
                    });

                    $this.find('[name="umap-id"]').change(onMapChanged);
                    $this.find('[name="wolf"], [name="diff"], [name="score"]').change(calc);
                    onMapChanged();

                    function onMapChanged() {
                        let mid = $this.find('[name="umap-id"] option:selected').val();
                        GameMap.currentMap = new GameMap(mid);
                        showMapWolfs(mid);
                        calc();
                        showCharts(mid);
                    }

                    function showMapWolfs(mid) {
                        $this.find('[name="wolf-buttons"]').html(
                            GlobalData.$_map_Obj[mid].wolf_proportion
                                .map(t => MonsterManager.getOnlyExample().getData(t[1]))
                                .map(t => `<span value="${t.id}">${t.name}<sup>${t.population}</sup></span>`).join("")
                        );
                        $this.find('[name="wolf-buttons"]').children().click(function (e) {
                            $this.find('[name="wolf"]').val(this.getAttribute("value"));
                            calc();
                        });
                    }

                    function calc() {
                        let umap_id = $this.find('[name="umap-id"] option:selected').val();
                        let wolf_id = $this.find('[name="wolf"] option:selected').val();
                        let diff = parseFloat($this.find('[name="diff"] option:selected').val());
                        let score = parseInt($this.find('[name="score"]').val());

                        let mapData = GameMap.getMapData(umap_id);
                        let level = Math.sqrt(mapData.hardA + mapData.hardB * score);

                        let wolf = new Monster(wolf_id, level, diff);
                        wolf.initSkills();

                        $this.find('[name="umap-diff"]').text(`${mapData.hardA}, ${mapData.hardB}`);
                        $this.find('[name="hp-factor"]').text(`${wolf.monsterData.hpMaxA}, ${wolf.monsterData.hpMaxB}, ${wolf.monsterData.hpMaxC}`);
                        $this.find('[name="pass-score"]').text(`${mapData.scoreMax}`);
                        $this.find('[name="level"]').text(level.toFixed(2));
                        $this.find('[name="hpMax"]').text(Math.floor(wolf.hpMax));

                        showHpChart(umap_id);
                    }

                    function showHpChart(mid) {
                        const chartOption = {
                            color: ["#00A2E8"],
                            title: {
                                left: 'center',
                                textStyle: {
                                    fontStyle: 'normal',
                                    fontFamily: 'sans-serif',
                                    fontSize: 16
                                }
                            },
                            tooltip: {},
                            legend: { show: false },
                            xAxis: {
                                type: 'value',
                                axisLine: {
                                    show: true,
                                    lineStyle: { width: 1, type: 'solid' }
                                }
                            },
                            yAxis: {
                                type: 'category',
                                axisTick: { alignWithLabel: true },
                                axisLabel: {
                                    textStyle: { fontSize: 14 }
                                }
                            },
                            grid: { x: 100, y: 30, y2: 20 },
                            series: [{
                                type: 'bar', barWidth: '60%',
                                label: {
                                    show: true,
                                    position: 'right'
                                },
                                showBackground: true,
                                backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)' }
                            }]
                        };

                        let _mapData = GameMap.getMapData(mid);
                        GameMap.currentMap.score = parseInt($this.find('[name="score"]').val());
                        let _wave = new Wave(new WaveData({ hard_ness: parseFloat($this.find('[name="diff"] option:selected').val()) }));
                        let _wolfList = _mapData.monsterList.map(t => new Monster(t, _wave.difficultyLevel, _wave.difficultyValue))
                        let chart = echarts.init($(".hp-chart")[0]);
                        chart.setOption(chartOption);
                        chart.setOption({
                            title: { text: "当前狼血量", },
                            yAxis: { data: _wolfList.map(t => t.monsterData.name) },
                            series: [{ data: _wolfList.map(t => t.hpMax) }]
                        });
                    }

                    function showCharts(mid) {
                        const chartOption = {
                            color: ["#92D050"],
                            title: {
                                left: 'center',
                                textStyle: {
                                    fontStyle: 'normal',
                                    fontFamily: 'sans-serif',
                                    fontSize: 14
                                }
                            },
                            tooltip: {},
                            legend: { show: false },
                            xAxis: {
                                type: 'category',
                                axisTick: { alignWithLabel: true }
                            },
                            yAxis: {
                                type: 'value',
                                axisLine: {
                                    show: true,
                                    lineStyle: { width: 1, type: 'solid' }
                                },
                                axisTick: {
                                    show: true,
                                    inside: true,
                                    length: 3,
                                    lineStyle: { width: 1, type: 'solid' }
                                }
                            },
                            grid: { x1: 10, x2: 10, y: 10, y2: 20 },
                            series: [{ type: 'bar', barWidth: '90%' }]
                        };

                        let $chartArea = $this.find(".chart-area");
                        $chartArea.children('div').remove();

                        let wolfs = GlobalData.$_map_Obj[mid].wolf_proportion.map(t => t[1]);
                        let xData = range(0, wavegenFreq[mid].all.length + 1)
                        for (let i = 0; i < wolfs.length; i++) {
                            $chartArea.append('<div style="width: 400px;height:100px;"></div>');
                            let chart = echarts.init($chartArea.children("div:last")[0]);
                            chart.setOption(chartOption);
                            chart.setOption({
                                title: { text: GlobalData.$_wolfAtt_Obj[wolfs[i]].name, },
                                xAxis: { data: xData },
                                series: [{ data: wavegenFreq[mid].each[i] }]
                            });
                        }
                        {
                            $chartArea.append('<div style="width: 400px;height:150px;"></div>');
                            let chart = echarts.init($chartArea.children("div:last")[0]);
                            chart.setOption(chartOption);
                            chart.setOption({
                                color: ["#FF7F27"],
                                title: { text: "全部", },
                                xAxis: { data: xData },
                                series: [{ data: wavegenFreq[mid].all }]
                            });
                        }
                    }

                    function generateWave(mid) {
                        let umap = GlobalData.$_map_Obj[mid];
                        let one = 1.0;
                        let pop = umap.pop_max;
                        let wolfProp = umap.wolf_proportion.map(t => t[0]);
                        let wolfPop = umap.wolf_proportion.map(t => GlobalData.$_wolfAtt_Obj[t[1]].pop);
                        let wolfs = umap.wolf_proportion.map(t => t[1]);
                        let n = wolfPop.length;
                        if (n == 0) return [];

                        let mlist = []; // 狼组成
                        let clist = new Array(n).fill(0); // 各种狼数量

                        while (pop > 0) {
                            while (pop < wolfPop[n - 1]) {
                                n--;
                            }
                            one = wolfProp[n - 1];
                            let p = Math.random() * one;
                            let k = _.findIndex(wolfProp, t => p < t);
                            pop -= wolfPop[k];
                            mlist.push(wolfs[k]);
                            clist[k]++;
                        }
                        return mlist;
                    }
                });

            </script>
        </section>

        <section data-section="research-notes" class="hide">
            <div>$\text{Stankle 对羊村的研究笔记}$</div>
            <div class="content"></div>
            <script type="text/javascript">

                $(document).ready(() => {
                    $.get("static/research_notes.md", function (response, status, xhr) {
                        $('[data-section="research-notes"] .content').html(formatMarktex(response));
                        //$('[data-section="research-notes"] div').html(marked(response));
                    });
                });
            </script>
        </section>
    </div>

</body>

</html>