<html>

<head>
    <title>TDSheepVillage Tools</title>
    <link rel="icon" href="image/icon.jpg" type="image/x-icon">

    <link href="css/style.css" rel="stylesheet">
    <link href="css/normalize.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>
    <script src="https://underscorejs.net/underscore-min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/2.1.3/marked.min.js"></script>
    <script src="exscore.js"></script>
    <script src="sort_table.js"></script>
    <script src="utils.js"></script>
    <script src="config.js"></script>
    <script src="config_funcs.js"></script>
</head>

<body>
    <aside>
        <div class="header">羊村数据小工具</div>
        <ul>
            <li><a data-section="towers">塔数据</a></li>
            <li><a data-section="wolfs">狼数据</a></li>
            <li><a data-section="umap-wolf">前线地图的狼</a></li>
            <li><a data-section="research-notes">研究笔记</a></li>
        </ul>
    </aside>
    <script>
        // 数据加载
        let tower = new Tower("shaota");
        tower.level = 50;
        //console.log(tower.buildCost(), tower.buffEffect(), tower.power, tower.ability, tower.valueCost(), tower.valueCostConst());
        tower.gem = new GemItem("lv4");

        $("aside ul").click(function (e) {
            if (e.target.tagName == "A") {
                switchSection(e.target.getAttribute("data-section"));
            }
        });


        function switchSection(secid) {
            $(`aside a[data-section="${secid}"]`).parent().addClass("active").siblings().removeClass("active");
            $(`section[data-section="${secid}"]`).removeClass("hide").siblings().addClass("hide");
        }

        $(document).ready(() => sortTable(".sortable"));
    </script>

    <div class="section-container">
        <section>
            <div><a href="https://github.com/QuadnucYard/tdsheepvillage-tools/tree/master">主页</a></div>
        </section>

        <section data-section="towers" class="hide">
            <form style="cursor: default;">
                <h1>防御塔数据</h1>
                <label>塔</label>
                <select name="tower-id"></select>
                <br>
                <label>等级上限：<label name="lev_max"></label></label>
                <br>
                <label>等级：</label>
                <input name="level" type="number" min=1 max=100 value=1>
                <br>
                <label>攻击力：<label name="damage"></label></label>&emsp;
                <label>攻击频率：<label name="rate"></label></label>&emsp;
                <label>攻击范围：<label name="range"></label></label>&emsp;
                <br>
                <label>ability: <label name="ability"></label></label>
                <br>
                <label>power: <label name="power"></label></label>
                <br>
                <label>buildValue: <label name="buildValue"></label></label>
                <br>
                <label>buildCost: <label name="buildCost"></label></label>
                <br>
                <label>valueCost: <label name="valueCost"></label></label>
                <br>
                <label>buffEffect: <label name="buffEffect"></label></label>
                <br>
                <br>
                <h2>升级计算</h2>
                从<input name="build-from" type="number" min=1 style="width: 3em;" value="0">级到<input name="build-to"
                    type="number" min=1 style="width: 3em;" value="1">级
                <br>
                苦工总力量：<input name="build-power" type="number" min=1 style="width: 5em;" value=1>
                <br>
                需要时间：<label name="build-time">NaN</label>
            </form>
            <script>
                !function () {
                    let $this = $('[data-section="towers"]');

                    $this.find('[name="tower-id"]').html(
                        _.map(config["building"]["tower"], (t, k) => [k, t["name"]])
                            .maps(t => `<option value=${t[0]}>${t[1]}</option>`)
                    );

                    $this.find('[name="tower-id"], [name="level"]').change(showData);
                    $this.find('[name="tower-id"], [name="build-from"], [name="build-to"], [name="build-power"]').change(calcBuildTime);

                    showData();
                    calcBuildTime();

                    function showData() {
                        let $this = $('[data-section="towers"]');

                        let tower_id = $this.find('[name="tower-id"] option:selected').val();
                        let level = parseInt($this.find('[name="level"]').val());

                        let towerData = config["building"]["tower"][tower_id];
                        let tower = new Tower(tower_id);
                        tower.level = level;

                        $this.find('[name="lev_max"]').text(tower.towerData.levelMax);
                        $this.find('[name="damage"]').text(tower.damage());
                        $this.find('[name="rate"]').text(tower.rate);
                        $this.find('[name="range"]').text(tower.range);
                        $this.find('[name="ability"]').text(tower.ability);
                        $this.find('[name="power"]').text(tower.power);
                        $this.find('[name="buildValue"]').text(tower.buildValue());
                        $this.find('[name="buildCost"]').text(tower.buildCost());
                        $this.find('[name="valueCost"]').text(tower.valueCost());
                        $this.find('[name="buffEffect"]').text(tower.buffEffect());
                    }

                    function calcBuildTime() {
                        let $this = $('[data-section="towers"]');

                        let tower_id = $this.find('[name="tower-id"] option:selected').val();
                        let buildFrom = parseInt($this.find('[name="build-from"]').val());
                        let buildTo = parseInt($this.find('[name="build-to"]').val());
                        let buildPower = parseInt($this.find('[name="build-power"]').val());

                        if (buildFrom >= buildTo) {
                            $this.find('[name="build-time"]').text("NaN");
                            return;
                        }

                        let tower = new Tower(tower_id);
                        let buildTime = 0;
                        for (let i = buildFrom + 1; i <= buildTo; i++) {
                            buildTime += tower.buildValue(i);
                        }
                        buildTime = Math.round(buildTime / buildPower);
                        $this.find('[name="build-time"]').text(`${Math.floor(buildTime / 3600)}:${Math.floor(buildTime % 3600 / 60)}:${buildTime % 60}`);
                    }
                }();
            </script>
        </section>

        <section data-section="wolfs" class="hide">
            <div class="content">
                <table class="pure-table">
                    <thead>
                        <tr>
                            <th class="sortable">id</th>
                            <th class="sortable">name</th>
                            <th class="sortable">speed</th>
                            <th class="sortable">pop</th>
                            <th class="sortable">charm</th>
                            <th class="sortable">hp_factor</th>
                            <th class="sortable">skills</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <script>
                !function () {


                    let $this = $('[data-section="wolfs"]');
                    $this.find(".content table tbody").append(_.map(config["wolfs"], (t, k) =>
                        [k, `<tr>
                            <td>${k}</td>
                            <td>${t.name.includes('^') ? t.name.takeFrom('^', 1) : t.name}</td>
                            <td>${t.speed}</td>
                            <td>${t.pop}</td>
                            <td>${t.charm}</td>
                            <td>${t.hp_factor.a}, ${t.hp_factor.b}, ${t.hp_factor.c}</td>
                            <td>${t.skills.maps(u => `${u.skid}[${u.lev}]`, ", ")}</td>
                        </tr>`]
                    ).sortBy(0).join(", "))
                }();
            </script>
        </section>

        <section data-section="umap-wolf" class="hide">
            <form>
                <h1>前线地图的狼</h1>
                <label>地图</label>
                <select name="umap-id"></select>
                <label name="umap-diff">难度系数：</label>
                <br>
                <label>狼</label>
                <select name="wolf"></select>
                <label name="hp-factor">血量系数：</label>
                <br>
                <label>进度</label>
                <input name="score" type="number" min=0 value=0>
                <label name="pass-score">通关进度：</label>
                <br>
                <label>难度</label>
                <select name="diff">
                    <option value=0.8>小菜一碟</option>
                    <option value=0.9>轻而易举</option>
                    <option value=1.0>势均力敌</option>
                    <option value=1.1>有惊无险</option>
                    <option value=1.2>稍有难度</option>
                    <option value=1.3>困难重重</option>
                </select>
                <br>
                <label>等级：</label><label name="level"></label>
                <label>最大血量：</label><label name="hpMax"></label>
            </form>

            <script>
                !function () {
                    let $this = $('[data-section="umap-wolf"]');

                    //console.log(parseInt(/(?<=m).+(?=[A-Z]*)/.exec("m9C")[0],20));

                    $this.find('[name="umap-id"]').html(
                        _.map(config["umaps"], (t, k) => [k, t["name"]]).sort((p1, p2) => {
                            return compareNumber(
                                parseInt(/(?<=m).+(?=[A-Z]*)/.exec(isAlpha(p1[0].last()) ? p1[0] : p1[0] + "A")[0], 36),
                                parseInt(/(?<=m).+(?=[A-Z]*)/.exec(isAlpha(p2[0].last()) ? p2[0] : p2[0] + "A")[0], 36),
                            );
                        }).maps(t => `<option value=${t[0]}>${t[0]} ${t[1]}</option>`)
                    );

                    $this.find('[name="wolf"]').html(
                        _.map(_.map(config["wolfs"], (t, k) => [k, t["name"]])
                            .groupBy(t => t[1].includes("camp") ? "防线" : (t[0].includes("D_") ? "噩梦" : "前线"))
                            , (t, k) => `<optgroup label="${k}">${t.sortBy(0).maps(s => `<option value=${s[0]}>${s[1].includes("^") ? s[1].takeFrom("^", 1) : s[1]
                                }</option>`)
                                }</optgroup>`)
                    );

                    $this.find('[name="umap-id"], [name="wolf"], [name="diff"], [name="score"]').change(calc);
                    calc();

                    function calc() {
                        let $this = $('[data-section="umap-wolf"]');
                        let umap_id = $this.find('[name="umap-id"] option:selected').val();
                        let wolf_id = $this.find('[name="wolf"] option:selected').val();
                        let diff = $this.find('[name="diff"] option:selected').val();
                        let score = $this.find('[name="score"]').val();

                        let hardA = config["umaps"][umap_id]["yield_val"];
                        let hardB = config["umaps"][umap_id]["hard_ness"];
                        let ha = config["wolfs"][wolf_id]["hp_factor"]["a"];
                        let hb = config["wolfs"][wolf_id]["hp_factor"]["b"];
                        let hc = config["wolfs"][wolf_id]["hp_factor"]["c"];

                        let level = Math.sqrt(hardA + hardB * score);
                        let hpMax = ((hc * level + hb) * level + ha) * diff;

                        $this.find('[name="umap-diff"]').text(`${hardA}, ${hardB}`);
                        $this.find('[name="hp-factor"]').text(`${ha}, ${hb}, ${hc}`);
                        $this.find('[name="pass-score"]').text(`${config["umaps"][umap_id]["pass_score"]}`);
                        $this.find('[name="level"]').text(level.toFixed(2));
                        $this.find('[name="hpMax"]').text(Math.floor(hpMax));

                        //console.log(hpMax);
                    }
                }();

            </script>
        </section>

        <section data-section="research-notes" class="hide">
            <div class="content"></div>
            <script>
                !function () {
                    $.get("static/research_notes.md", function (response, status, xhr) {
                        $('[data-section="research-notes"] div').html(marked(response));
                    });
                }();
            </script>
        </section>
    </div>

</body>

</html>